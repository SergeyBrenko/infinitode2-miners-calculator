<!--
  Infinitode 2 Miner Upgrade Cost Calculator (Single Section, Common Level)
  All miners displayed in one table with icons.
  Level picker is common for all miners.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Infinitode 2 — Miner Upgrade Cost Calculator</title>
  <style>
    :root{
      --bg:#0b0f16; --panel:#111827; --muted:#9ca3af; --accent:#22d3ee; --text:#e5e7eb; --ok:#34d399; --warn:#fbbf24;
      --radius:16px;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:720px;margin:0 auto;padding:24px;}
    header{margin-bottom:20px}
    h1{font-size:1.25rem;margin:0;letter-spacing:0.2px}
    .card{background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.3);margin-bottom:16px}

    label{font-size:.85rem;color:#cbd5e1;display:block;margin-bottom:6px}
    select,input[type="number"]{width:100%;background:#0f172a;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:8px 10px;border-radius:10px;font:inherit}
    select:focus,input[type="number"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(34,211,238,.18)}

    table{width:100%;border-collapse:collapse;font-size:.92rem}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:right}
    th:first-child,td:first-child{text-align:left}
    .icon-cell img{width:36px;height:36px;border-radius:8px;object-fit:contain;background:#0f172a}

    .total{font-weight:800}
    .sum{display:flex;justify-content:flex-end;gap:8px;align-items:center;margin-top:12px}
    .sum .label{color:var(--muted)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button{cursor:pointer;background:#0f172a;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:8px 12px;border-radius:10px;font:inherit}
    button:hover{border-color:var(--accent)}
    .accent{background:linear-gradient(90deg, #22d3ee, #34d399);border:none;color:#0b0f16;font-weight:800}

    footer{margin-top:20px;color:var(--muted);font-size:.85rem}
    .note{color:var(--warn)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Infinitode 2 — Miner Upgrade Cost Calculator</h1>
    </header>

    <div class="card">
      <label for="commonLevel">Upgrade Level (applies to all miners)</label>
      <select id="commonLevel"></select>
    </div>

    <div class="card" id="app"></div>

    <div class="card">
      <div class="sum"><span class="label">Grand total:</span> <span class="total" id="grandTotal">0</span></div>
      <div class="toolbar" style="margin-top:10px">
        <button id="resetBtn">Reset</button>
        <button class="accent" id="shareBtn">Share setup</button>
      </div>
      <footer>
        <p>Pricing rule used: each additional <b>upgrade from the same level</b> for a miner type costs <b>+25% multiplicative</b>, <b>floored each step</b>. Build price step-up (+60%) is <u>not</u> included.</p>
      </footer>
    </div>
  </div>

<script>
// ------------------ Data ------------------
// Miner icons and base upgrade costs (coins) for upgrading L→L+1, levels 0..9
const MINERS = {
  'SCL1-R': { upgrades:[150,400,1000,1500,2100,2800,3700,4800,6000,8000], icon:'https://static.wikia.nocookie.net/infinitode-2/images/7/73/Miner-Scalar.png/revision/latest/scale-to-width-down/500?cb=20190325230257' },
  'V2-CTR': { upgrades:[170,500,1200,1750,2300,3100,4300,5700,7200,9600], icon:'https://static.wikia.nocookie.net/infinitode-2/images/2/20/Miner-Vector.png/revision/latest/scale-to-width-down/500?cb=20190325230257' },
  'MTRX-3': { upgrades:[185,600,1400,2000,2500,3400,5000,6600,8400,11000], icon:'https://static.wikia.nocookie.net/infinitode-2/images/6/69/Miner-Matrix.png/revision/latest/scale-to-width-down/500?cb=20190325230256' },
  'TN4S-R': { upgrades:[240,750,1800,2400,2900,4000,5800,7400,9500,12500], icon:'https://static.wikia.nocookie.net/infinitode-2/images/1/14/Miner-Tensor.png/revision/latest/scale-to-width-down/500?cb=20190325230257' },
  'IN5-AR': { upgrades:[250,875,1900,2600,3500,5100,6600,8800,11000,14000], icon:'https://static.wikia.nocookie.net/infinitode-2/images/9/9c/Miner-Infiar.png/revision/latest/scale-to-width-down/500?cb=20190325230255' },
};

const UPGRADE_MULTIPLIER = 1.25; // +25% per additional upgrade from same level
const fmt = (n)=> n.toLocaleString(undefined, {maximumFractionDigits:0});

// ------------------ Persistence ------------------
const storageKey = 'inf2-miner-upgrade-single-v3';
function saveState(){
  const data = { commonLevel: Number(document.querySelector('#commonLevel')?.value || 0), miners: {} };
  for (const key of Object.keys(MINERS)){
    const qty = Number(document.querySelector(`#qty-${key}`)?.value || 0);
    const already = Number(document.querySelector(`#alr-${key}`)?.value || 0);
    data.miners[key] = { qty, already };
  }
  localStorage.setItem(storageKey, JSON.stringify(data));
}
function loadState(){
  try { return JSON.parse(localStorage.getItem(storageKey) || '{}'); }
  catch { return {}; }
}

// ------------------ Math ------------------
function costBatch(minerKey, level, qty, already){
  const base = MINERS[minerKey].upgrades[level];
  let sum = 0;
  for(let i=0;i<qty;i++){
    const stepIndex = already + i;
    sum += Math.floor(base * Math.pow(UPGRADE_MULTIPLIER, stepIndex));
  }
  return sum;
}

// ------------------ UI ------------------
function ensureLevelOptions(){
  const sel = document.getElementById('commonLevel');
  if(!sel) return;
  if(sel.options.length === 0){
    for(let l=0;l<10;l++){
      const opt = document.createElement('option');
      opt.value = String(l);
      opt.textContent = `${l}→${l+1}`;
      sel.appendChild(opt);
    }
  }
}

function render(){
  const state = loadState();
  const app = document.getElementById('app');
  app.innerHTML = '';

  ensureLevelOptions();
  const levelSel = document.getElementById('commonLevel');
  if(levelSel) levelSel.value = String(state?.commonLevel ?? 0);

  let grand = 0;

  // Build one table containing all miners
  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr>
        <th>Miner</th>
        <th>Qty</th>
        <th>Already</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody id="minerBody"></tbody>
  `;
  app.appendChild(table);

  const tbody = table.querySelector('#minerBody');
  const currentLevel = Number(document.getElementById('commonLevel')?.value || 0);

  Object.keys(MINERS).forEach((key)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="icon-cell"><img src="${MINERS[key].icon}" alt="${key}" referrerpolicy="no-referrer" title="${key}"/></td>
      <td><input id="qty-${key}" type="number" min="0" step="1" value="0"/></td>
      <td><input id="alr-${key}" type="number" min="0" step="1" value="0"/></td>
      <td><div id="sub-${key}" class="total">0</div></td>
    `;
    tbody.appendChild(tr);

    const s = state?.miners?.[key] || { qty:0, already:0 };
    tr.querySelector(`#qty-${key}`).value = s.qty;
    tr.querySelector(`#alr-${key}`).value = s.already;

    const subtotal = costBatch(key, currentLevel, s.qty, s.already);
    tr.querySelector(`#sub-${key}`).textContent = fmt(subtotal);
    grand += subtotal;
  });

  document.getElementById('grandTotal').textContent = fmt(grand) + ' (' + fmt(grand + 3500) + ')';

  // Events
  document.getElementById('commonLevel').addEventListener('change', ()=>{ recalc(); saveState(); });
  app.querySelectorAll('input[type="number"]').forEach(el=>{
    el.addEventListener('input', ()=>{ recalc(); saveState(); });
  });
}

function recalc(){
  let grand = 0;
  const level = Number(document.querySelector('#commonLevel').value || 0);
  for(const key of Object.keys(MINERS)){
    const qty = Number(document.querySelector(`#qty-${key}`).value || 0);
    const alr = Number(document.querySelector(`#alr-${key}`).value || 0);
    const subtotal = costBatch(key, level, qty, alr);
    document.querySelector(`#sub-${key}`).textContent = fmt(subtotal);
    grand += subtotal;
  }
  document.getElementById('grandTotal').textContent = fmt(grand) + ' (' + fmt(grand + 3500) + ')';
}

// ------------------ Share ------------------
function encodeShare(){
  const data = { commonLevel: Number(document.querySelector('#commonLevel').value || 0), miners: {} };
  for(const key of Object.keys(MINERS)){
    const qty = Number(document.querySelector(`#qty-${key}`).value || 0);
    const already = Number(document.querySelector(`#alr-${key}`).value || 0);
    data.miners[key] = { qty, already };
  }
  return btoa(unescape(encodeURIComponent(JSON.stringify(data))));
}
function decodeShare(str){
  try{ return JSON.parse(decodeURIComponent(escape(atob(str)))); }catch{ return null; }
}

// ------------------ Init ------------------
render();
recalc();

// Controls
 document.getElementById('resetBtn').addEventListener('click', ()=>{
   localStorage.removeItem(storageKey);
   render();
   recalc();
 });
 document.getElementById('shareBtn').addEventListener('click', ()=>{
   const token = encodeShare();
   const url = location.origin + location.pathname + '#'+token;
   navigator.clipboard.writeText(url).then(()=>{ alert('Sharable link copied to clipboard!'); });
 });

 // Load from hash if present
 if(location.hash && location.hash.length>1){
   const data = decodeShare(location.hash.slice(1));
   if(data){
     const levelSel = document.querySelector('#commonLevel');
     if(levelSel) levelSel.value = data.commonLevel || 0;
     if(data.miners){
       for(const key of Object.keys(MINERS)){
         const s = data.miners[key];
         if(s){
           const qty = document.querySelector(`#qty-${key}`);
           const alr = document.querySelector(`#alr-${key}`);
           if(qty) qty.value = s.qty || 0;
           if(alr) alr.value = s.already || 0;
         }
       }
     }
     saveState();
     recalc();
   }
 }

// ------------------ Minimal Tests ------------------
(function runTests(){
  // Base sanity: SCL1-R L0 base=150; three upgrades with already=0 => 150 + floor(187.5) + floor(234.375) = 571
  console.assert(costBatch('SCL1-R', 0, 3, 0) === 571, 'Test1 failed');
  // With already=2, qty=1 => floor(150 * 1.25^2) = floor(234.375) = 234
  console.assert(costBatch('SCL1-R', 0, 1, 2) === 234, 'Test2 failed');
  // Zero qty should be zero
  console.assert(costBatch('V2-CTR', 5, 0, 10) === 0, 'Test3 failed');
  // Non-zero qty, different miner/level
  console.assert(typeof costBatch('IN5-AR', 9, 2, 1) === 'number', 'Test4 failed');
  console.log('[Tests] Completed basic checks');
})();
</script>
</body>
</html>

<!-- ===================== Dockerfile =====================
FROM nginx:alpine
COPY index.html /usr/share/nginx/html/index.html
EXPOSE 80
# CMD provided by base image
======================================================== -->

